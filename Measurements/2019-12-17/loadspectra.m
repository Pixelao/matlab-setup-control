%%plot all
files=dir('*.mat');
for i=1:length(files)
    name(i)=sscanf(files(i).name,'V=%g.mat');
end
name=sort(name);
figure(1);
axis([1.8 2.3 0 0.4*length(name)])
figure(2);
color=linspace(0,1,length(name));
LF=@(I,x0,gamma,x) I./(1+((x-x0)/gamma).^2);%lorentzianfunction
for i=1:length(name)
    %if i==25
        %nada
    %else
    load(['V=' num2str(name(i)) '.mat'])
    Photocurrent(:)=MeasurementData.LI(1,1,:);
    SMcurrent(:)=MeasurementData.SM.I(1,1,:);
    I0(i,1)=SMcurrent(1);
    If(i,1)=SMcurrent(length(SMcurrent));
    SMcurrent(length(SMcurrent))=[];
    WL(:)=MeasurementData.WL(1,1,:);
    WL(length(WL))=[];
    Photocurrent(length(Photocurrent))=[];
    E=1240./(WL-23);
    Pnorm=Photocurrent/max(Photocurrent);
    options = optimoptions('lsqcurvefit','MaxFunEvals',10000,'MaxIter',2000);
        Fit=@(p,x) LF(p(1),p(2),p(3),x)+...
        LF(p(4),p(5),p(6),x)+...
        LF(p(7),p(8),p(9),x)+...
        LF(p(10),p(11),p(12),x)+...
        LF(p(13),p(14),p(15),x)+...
        LF(p(16),p(17),p(18),x)+...
        LF(p(19),p(20),p(21),x)+...
        LF(p(22),p(23),p(24),x)+...
        LF(p(25),p(26),p(27),x)+...
        LF(p(28),p(29),p(30),x)+...
        p(31);
    guess=[1 1.7948 0.01 ...
           1 1.89 0.01 ...
           1 1.9261 0.01 ... 
           1 1.955 0.01 ... 
           1 2.0833 0.01 ... 
           1 2.1007 0.01 ...
           1 2.1361 0.01 ...
           1 2.2311 0.01 ...
           1 2.2845 0.01 ...
           1 2.3401 0.01 ...
            1];
    lb=[0 1.79 0 ...
        0 1.875 0 ...
        0 1.91 0 ... %exciton A
        0 1.95 0 ... %trion B
        0 2.05 0 ... %exciton B
        0 2.075 0 ... 
        0 2.12 0 ...
        0 2.2 0 ...
        0 2.25 0 ...
        0 2.3 0 ...
        0];
    ub=[inf 1.81 0.1 ...
        inf 1.905 0.1 ...
        inf 1.93 0.07 ... 
        inf 1.97 0.06 ... 
        inf 2.087 0.1 ... 
        inf 2.10 0.1 ... 
        inf 2.15 0.1 ...
        inf 2.25 1 ...
        inf 2.3 inf ...
        inf 2.4 inf ...
        inf];
    p(:,i)=lsqcurvefit(Fit,guess,E,Pnorm,lb,ub,options);
    hold on
    figure(1);
Pnorm=Photocurrent/max(Photocurrent);
    options = optimoptions('lsqcurvefit','MaxFunEvals',10000,'MaxIter',2000);
        Fit=@(p,x) LF(p(1),p(2),p(3),x)+...
        LF(p(4),p(5),p(6),x)+...
        LF(p(7),p(8),p(9),x)+...
        LF(p(10),p(11),p(12),x)+...
        LF(p(13),p(14),p(15),x)+...
        LF(p(16),p(17),p(18),x)+...
        LF(p(19),p(20),p(21),x)+...
        LF(p(22),p(23),p(24),x)+...
        LF(p(25),p(26),p(27),x)+...
        LF(p(28),p(29),p(30),x)+...
        p(31);
    guess=[1 1.7948 0.05 ...
           1 1.91 0.05 ...
           1 1.94 0.05 ... 
           1 1.955 0.05 ... 
           1 2.0833 0.05 ... 
           1 2.1007 0.05 ...
           1 2.1361 0.05 ...
           1 2.2311 0.05 ...
           1 2.2845 0.05 ...
           1 2.3401 0.05 ...
            1];
    lb=[0 1.79 0 ...
        0 1.90 0 ...
        0 1.93 0 ... %exciton A
        0 1.95 0 ... %trion B
        0 2.05 0 ... %exciton B
        0 2.075 0 ... 
        0 2.12 0 ...
        0 2.2 0 ...
        0 2.25 0 ...
        0 2.3 0 ...
        0];
    ub=[inf 1.81 0.2 ...
        inf 1.92 0.06 ...
        inf 1.95 0.06 ... 
        inf 1.97 0.06 ... 
        inf 2.087 0.1 ... 
        inf 2.10 0.1 ... 
        inf 2.15 0.1 ...
        inf 2.25 1 ...
        inf 2.3 inf ...
        inf 2.4 inf ...
        inf];
    p(:,i)=lsqcurvefit(Fit,guess,E,Pnorm,lb,ub,options);
    hold on
    figure(1);
    hold on
    plot(E,Pnorm+2*i,'color',[color(i),0,0],'linewidth',1);
     plot(E,Fit(p(:,i),E)+2*i,'linewidth',1,'color',[1,0.84,0.65]);
     plot(E,LF(p(1,i),p(2,i),p(3,i),E)+p(31,i)+2*i,'c--','linewidth',1);plot(E,LF(p(4,i),p(5,i),p(6,i),E)+p(31,i)+2*i,'b--','linewidth',1);
     plot(E,LF(p(7,i),p(8,i),p(9,i),E)+p(31,i)+2*i,'b--','linewidth',1);plot(E,LF(p(10,i),p(11,i),p(12,i),E)+p(31,i)+2*i,'c--','linewidth',1);
     plot(E,LF(p(13,i),p(14,i),p(15,i),E)+p(31,i)+2*i,'r--','linewidth',1);plot(E,LF(p(16,i),p(17,i),p(18,i),E)+p(31,i)+2*i,'r--','linewidth',1);
     plot(E,LF(p(19,i),p(20,i),p(21,i),E)+p(31,i)+2*i,'g--','linewidth',0.5);plot(E,LF(p(22,i),p(23,i),p(24,i),E)+p(31,i)+2*i,'g--','linewidth',0.5);
     plot(E,LF(p(25,i),p(26,i),p(27,i),E)+p(31,i)+2*i,'g--','linewidth',0.5);plot(E,LF(p(28,i),p(29,i),p(30,i),E)+p(31,i)+2*i,'g--','linewidth',0.5);
    figure(2);
    hold on
    plot(E,SMcurrent,'color',[color(i),0,0]);
    clear Photocurrent WL E SMcurrent Pnorm Energy
    %end
end
hold off
figure(3);hold on
plot(name,I0,'o-');plot(name,If,'o-');
