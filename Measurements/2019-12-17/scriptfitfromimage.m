%%Script to adjust different spectra with lorentzian functions
%%load from image
clear xx yy x y
fig=gco;
xx=fig.XData;yy=fig.YData;
%normalization and smooth to the exciton B peak
%Pnorm=smoothdata(Photocurrent/max(Photocurrent),'sgolay',5);
y=yy/max(yy);
%plotdata
figure;plot(xx,y,'.');
%lorentzianfit
Numberofpeaks=8;%select the number of peaks


LF=@(I,x0,gamma,x) I./(1+((x-x0)/gamma).^2);%lorentzianfunction
options = optimoptions('lsqcurvefit','MaxFunEvals',10000,'MaxIter',2000);

if Numberofpeaks==1
    Fit=@(p,x) LF(p(1),p(2),p(3),x)+p(4);
    guess=[1 1.9 0.1 1];
    lb=[0 1.8 0 0];
    ub=[inf inf inf inf];
    p(:,1)=lsqcurvefit(Fit,guess,x,y,lb,ub,options);
    figure; hold on; plot(xx,y,'r.');
    plot(xx,Fit(p,xx),'b');
    plot(xx,LF(p(1),p(2),p(3),xx),'k');
    hold off
elseif Numberofpeaks==2
    Fit=@(p,x) LF(p(1),p(2),p(3),x)+...
        LF(p(4),p(5),p(6),x)+...
        p(7);
    guess=[1 1.9 0.1 ...
           1 2 0.1 ...
           1];
    lb=[0 1.8 0 ...
        0 1.8 0 ...
        0];
    ub=[inf 3 inf ... 
        inf 3 inf ... 
        inf];
    p(:,1)=lsqcurvefit(Fit,guess,xx,y,lb,ub,options);
    figure; hold on; plot(xx,y,'r.');plot(xx,Fit(p,xx),'b');
    plot(xx,LF(p(1),p(2),p(3),xx)+p(7),'k'),plot(xx,LF(p(4),p(5),p(6),xx)+p(7),'k');
    hold off
elseif Numberofpeaks==3
    Fit=@(p,x) LF(p(1),p(2),p(3),x)+...
        LF(p(4),p(5),p(6),x)+...
        LF(p(7),p(8),p(9),x)+p(10);
    guess=[1 1.9 0.1...
        1 2 0.1...
        1 2 0.1...
        1];
    lb=[0 1.8 0 ...
        0 1.8 0 ...
        0 1.9 0 ...
        0];
    ub=[inf 3 inf...
        inf 3 inf...
        inf 3 inf...
        inf];
    p(:,1)=lsqcurvefit(Fit,guess,xx,y,lb,ub,options);
    figure; hold on; plot(xx,y,'r.');plot(xx,Fit(p,xx),'b');
    plot(xx,LF(p(1),p(2),p(3),xx)+p(10),'k');plot(xx,LF(p(4),p(5),p(6),xx)+p(10),'k');
    plot(xx,LF(p(7),p(8),p(9),xx)+p(10),'k');
    hold off
elseif Numberofpeaks==4
    Fit=@(p,x) LF(p(1),p(2),p(3),x)+...
        LF(p(4),p(5),p(6),x)+...
        LF(p(7),p(8),p(9),x)+...
        LF(p(10),p(11),p(12),x)+p(13);
    guess=[1 1.9 0.1...
        1 1.9 0.1 ...
        1 2 0.1...
        1 2 0.1 ...
        1];
    lb=[0 1.8 0 ...
        0 1.8 0 ...
        0 1.8 0 ...
        0 1.8 0 ... 
        0];
    ub=[inf 2.2 inf ...
        inf 2.2 inf ...
        inf 2.2 inf ...
        inf 2.2 inf ...
        inf];
    p(:,1)=lsqcurvefit(Fit,guess,xx,y,lb,ub,options);
    figure; hold on; plot(xx,y,'r.');plot(xx,Fit(p,xx),'b');
    plot(xx,LF(p(1),p(2),p(3),xx)+p(13),'k');plot(xx,LF(p(4),p(5),p(6),xx)+p(13),'k');
    plot(xx,LF(p(7),p(8),p(9),xx)+p(13),'k');plot(xx,LF(p(10),p(11),p(12),xx)+p(13),'k');
    hold off
elseif Numberofpeaks==5
    Fit=@(p,x) LF(p(1),p(2),p(3),x)+...
        LF(p(4),p(5),p(6),x)+...
        LF(p(7),p(8),p(9),x)+...
        LF(p(10),p(11),p(12),x)+...
        LF(p(13),p(14),p(15),x)+...
        p(16);
    guess=[1 1.91 0.01 ...
           1 1.94 0.01 ...
           1 2.0939 0.01 ...
           1 2.10 0.01 ...
           1 2.5 0.01 ...
            0.5];
    lb=[0 1.905 0 ...
        0 1.93 0 ... 
        0 2.05 0 ...
        0 2.05 0 ...
        0 2.2 0 ...
        0];
    ub=[inf 1.92 inf ...
        inf 1.95 inf ...
        inf 3 inf ...
        inf 3 inf ...
        inf 3 inf ...
        inf];
    p(:,1)=lsqcurvefit(Fit,guess,xx,y,lb,ub,options);
    figure; hold on; plot(xx,y,'b');plot(xx,Fit(p,xx),'r');
    plot(xx,LF(p(1),p(2),p(3),xx)+p(16),'k');plot(xx,LF(p(4),p(5),p(6),xx)+p(16),'k');
    plot(xx,LF(p(7),p(8),p(9),xx)+p(16),'k');plot(xx,LF(p(10),p(11),p(12),xx)+p(16),'k');
    plot(xx,LF(p(13),p(14),p(15),xx)+p(16),'k');
elseif Numberofpeaks==6
    Fit=@(p,x) LF(p(1),p(2),p(3),x)+...
        LF(p(4),p(5),p(6),x)+...
        LF(p(7),p(8),p(9),x)+...
        LF(p(10),p(11),p(12),x)+...
        LF(p(13),p(14),p(15),x)+...
        LF(p(16),p(17),p(18),x)+...
        p(19);
    guess=[1 1.9142 0.1 ... %trion A
           1 1.9387 0.1 ... %exciton A
           1 2.0922 0.1 ... %trion B
           1 2.1132 0.1 ... %exciton B
           1 2.16 0.1 ...
           1 2.05 0.1 ...
            1];
    lb=[0 1.91 0 ... %trion A
        0 1.93 0 ... %exciton A
        0 2.08 0 ... %trion B
        0 2.09 0 ... %exciton B
        0 2.10 0 ... 
        0 2.2 0 ...
        0];
    ub=[inf 1.925 0.1 ... %trion A
        inf 1.94 0.07 ... %exciton A
        inf 2.1 0.1 ... %trion B
        inf 2.12 0.07 ... %exciton B
        inf 3 inf ... 
        inf 3 inf ...
        inf];
    p(:,1)=lsqcurvefit(Fit,guess,xx,y,lb,ub,options);
    figure; hold on; plot(xx,y,'r.');plot(xx,Fit(p,xx),'b');
    plot(xx,LF(p(1),p(2),p(3),xx)+p(19),'k');plot(xx,LF(p(4),p(5),p(6),xx)+p(19),'k');
    plot(xx,LF(p(7),p(8),p(9),xx)+p(19),'k');plot(xx,LF(p(10),p(11),p(12),xx)+p(19),'k');
    plot(xx,LF(p(13),p(14),p(15),xx)+p(19),'k');plot(xx,LF(p(16),p(17),p(18),xx)+p(19),'k');
elseif Numberofpeaks==7
    Fit=@(p,x) LF(p(1),p(2),p(3),x)+...
        LF(p(4),p(5),p(6),x)+...
        LF(p(7),p(8),p(9),x)+...
        LF(p(10),p(11),p(12),x)+...
        LF(p(13),p(14),p(15),x)+...
        LF(p(16),p(17),p(18),x)+...
        LF(p(19),p(20),p(21),x)+...
        p(22);
    guess=[1 1.9142 0.1 ... %trion A
           1 1.9387 0.1 ... %exciton A
           1 2.0922 0.1 ... %trion B
           1 2.1132 0.1 ... %exciton B
           1 2.23 0.1 ...
           1 2.34 0.1 ...
           1 2.4 0.1 ...
            1];
    lb=[0 1.91 0 ... %trion A
        0 1.93 0 ... %exciton A
        0 2.08 0 ... %trion B
        0 2.09 0 ... %exciton B
        0 2.21 0 ... 
        0 2.3 0 ...
        0 2.4 0 ...
        0];
    ub=[inf 1.925 0.1 ... %trion A
        inf 1.94 0.07 ... %exciton A
        inf 2.1 0.1 ... %trion B
        inf 2.12 inf ... %exciton B
        inf 3 inf ... 
        inf 3 inf ...
        inf 3 inf ...
        inf];
    p(:,1)=lsqcurvefit(Fit,guess,xx,y,lb,ub,options);
    figure; hold on; plot(xx,y,'r.');plot(xx,Fit(p,xx),'b');
    plot(xx,LF(p(1),p(2),p(3),xx)+p(22),'k');plot(xx,LF(p(4),p(5),p(6),xx)+p(22),'k');
    plot(xx,LF(p(7),p(8),p(9),xx)+p(22),'k');plot(xx,LF(p(10),p(11),p(12),xx)+p(22),'k');
    plot(xx,LF(p(13),p(14),p(15),xx)+p(22),'k');plot(xx,LF(p(16),p(17),p(18),xx)+p(22),'k');
    plot(xx,LF(p(19),p(20),p(21),xx)+p(22),'k');
elseif Numberofpeaks==8
    Fit=@(p,x) LF(p(1),p(2),p(3),x)+...
        LF(p(4),p(5),p(6),x)+...
        LF(p(7),p(8),p(9),x)+...
        LF(p(10),p(11),p(12),x)+...
        LF(p(13),p(14),p(15),x)+...
        LF(p(16),p(17),p(18),x)+...
        LF(p(19),p(20),p(21),x)+...
        LF(p(22),p(23),p(24),x)+...
        p(25);
    guess=[1 1.9142 0.01 ... %trion A
           1 1.9387 0.01 ... %exciton A
           1 2.0922 0.01 ... %trion B
           1 2.1132 0.01 ... %exciton B
           1 2.24 0.01 ...
           1 2.34 0.01 ...
           1 2.4 0.01 ...
           1 2.4 0.01 ...
            1];
    lb=[0 1.91 0 ... %trion A
        0 1.93 0 ... %exciton A
        0 2.08 0 ... %trion B
        0 2.09 0 ... %exciton B
        0 2.23 0 ... 
        0 2.30 0 ...
        0 2.4 0 ...
        0 2.4 0 ...
        0];
    ub=[inf 1.925 0.1 ... %trion A
        inf 1.95 0.1 ... %exciton A
        inf 2.1 0.1 ... %trion B
        inf 2.13 0.1 ... %exciton B
        inf 2.28 0.1 ... 
        inf 2.34 0.1 ...
        inf 2.6 1 ...
        inf 2.6 inf ...
        inf];
    p(:,1)=lsqcurvefit(Fit,guess,xx,y,lb,ub,options);
    figure; hold on; plot(xx,y,'r.');plot(xx,Fit(p,xx),'b');
    plot(xx,LF(p(1),p(2),p(3),xx)+p(25),'k');plot(xx,LF(p(4),p(5),p(6),xx)+p(25),'k');
    plot(xx,LF(p(7),p(8),p(9),xx)+p(25),'k');plot(xx,LF(p(10),p(11),p(12),xx)+p(25),'k');
    plot(xx,LF(p(13),p(14),p(15),xx)+p(25),'k');plot(xx,LF(p(16),p(17),p(18),xx)+p(25),'k');
    plot(xx,LF(p(19),p(20),p(21),xx)+p(25),'k');plot(xx,LF(p(22),p(23),p(24),xx)+p(25),'k');
    end
%clear p